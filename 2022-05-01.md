---
marp: true
title: "r3f but not React"
description: "r3f but not React"
authors: tsei
hide_table_of_contents: false
tags: [Three.js, React.js, react-three-fiber, react-spring, rafz, requestAnimationFrame]
---

# r3f but not React

[Computer Graphics Ninja][cgninja] ã«ã¨ã£ã¦Three.jsã§ã¯ã¤ã‚‰ã„ã“ã¨ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚
ã¾ãšã²ã¨ã¤ã«ã€memoryã‚’æŠ‘ãˆã‚‹ãŸã‚ã€ä½¿ã„ãŠã‚ã£ãŸã‚ã¨ã¯ [`.dispose()`][dispose] ã™ã‚‹ã®ã§ã€
å…¨ã¦ã®å¤‰æ•°ã‚’ã‚ã¤ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆä»–ã«ã‚‚ [trackã‚’ã¤ã‹ã†æ–¹æ³•][track] ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰
ã¾ãŸã€[æ¯frameã®å‡¦ç†ã‚’ä¸€ã‹æ‰€ã«é›†ã‚ã‚‹][threejs] å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚
[ThreeController test - CodeSandbox][demo]

[cgninja]: https://www.amazon.co.jp/dp/B000FBJCJE
[threejs]: https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene
[dispose]: https://threejs.org/docs/#manual/en/introduction/How-to-dispose-of-objects
[track]: https://r105.threejsfundamentals.org/threejs/lessons/threejs-cleanup.html
[demo]: https://codesandbox.io/s/threecontroller-test-5ho9pf

<!-- truncate -->

```js
function animate() {
  requestAnimationFrame( animate );
  /* ~~ all frame process here, but... ~~ */
  renderer.render( scene, camera );
}
animate();
```

---

r3fã¯instanceã‚’è‡ªç”±ã«æ‰±ãˆãŸã‚Šã€æ¯frameå‡¦ç†ã‚’è‡ªç”±ã«è¿½åŠ ã§ãã‚‹ã®ã§ã€
é•·ã‚ã®codeã§ã‚‚ã€globalå¤‰æ•°ãŒãªããªã£ãŸã‚Šã€èª­ã¿ã‚„ã™ããªã‚Šã¾ã™ã€‚
ä»Šå›ã¯ã€ã“ã® `react-three-fiber` ã‚’ã€Reactãªã—ã§å†ç¾ã—ã¦ã„ãã¾ã™ã€‚

```js
import { useRef, useEffect } from "react";
import { useFrame, useThree } from "@react-three/fiber";

function useOrbit() {
    const controlsRef = useRef(null);

    useEffect(() => () => void controlsRef.current?.dispose(), []);

    useFrame(() => void controlsRef.current?.update());

    useThree((state) => {
      controlsRef.current = new OrbitControls(state.camera, state.gl.domElement);
    });
}
```

---

## Getting Started

### makeQueue ã«ã¤ã„ã¦

frameå‡¦ç†ã™ã‚‹functionã‚’æ‰±ã†ãŸã‚ã«ã€`react-spring` ã® `makeQueue`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ã‚‚ã—errorãŒ60fpsã§å‡ºã‚‹ã¨browserãŒè½ã¡ã‚‹ã®ã§ã€`each` ã‹ã‚‰ `try` ã‚’é€šã—ã¾ã™ã€‚

---

```js
function each(values, each=(value) => value) {
  values.forEach(value => {
    try {
      each(value);
    } catch (e) {
      console.error(e);
    }
  })
}
```

---

```js
function makeQueue() {
  let next = new Set();
  let current = next;
  return {
    add: (fun) => next.add(fun),
    delete: (fun) => next.delete(fun),
    flush: (...args) => {
      if (current.size) {
        next = new Set();
        current = next;
        each(current, (fun) => fun(...args) && next.add(fun));
      }
    }
  }
}
```

---

### ThreeControllerã‚’ã¤ãã‚‹

`react-spring`ã® `rafz` ã‚’å‚è€ƒã«ã€animation frameã‚’åˆ¶å¾¡ã—ã¦ã„ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã« `state` ã‚’ä½¿ã†ã“ã¨ã§ã€è‡ªç”±ã«è¿½åŠ ã—ãŸã‚Šæ“ä½œã§ãã¾ã™ã€‚

---

```js
class ThreeController {
  constructor() {
    let ts = -1, id = -1;
    let queue = _makeQueue();
    const raf = (fun=()=>{}) => void (id = requestAnimationFrame(fun));
    const caf = () => (ts = -1, id > 0 && cancelAnimationFrame(id));
    const loop = () => ts > -1 && void (raf(loop), queue.flush());
    const start = () => ts < 0 && void (raf(loop), ts++);
    const state = (fun) => void (queue.add(fun), start());
    this.state = state;
    state.add = (fun) => void queue.add(fun);
    state.delete = (fun) => void queue.delete(fun);
    state.cancel = () => void (queue = _makeQueue(), caf());
  }
```

---

```js
  effect() {
    const { state } = this;
    this._initialize();
    state(state.render);
  }

  clean() {
    const { state } = this;
    if (!state.isInitialized) return;
    state.isInitialized = false;
    state.gl.dispose();
    state.cancel();
  }
```

---

```js
  _initialize() {
    const { props, state } = this;
    const { canvas } = props;
    if (state.isInitialized) return;
    state.isInitialized = true;
    state.scene = new THREE.Scene();
    state.camera = new THREE.PerspectiveCamera(75, 0, 0.1, 1000)
    state.gl = new THREE.WebGLRenderer({ canvas });
    state.render = () => (void state.gl.render(state.scene, state.camera)) || true;
  }
}
```

---

### å›ºæœ‰ãªfunctionã«ã™ã‚‹

`queue` ã«è¿½åŠ æ™‚ã€functionãŒé‡è¤‡ã—ãªã„ã‚ˆã†å›ºæœ‰ãªfunctionã«ã—ã¾ã™ã€‚
`useRaf` ã¯æŒ‡å®šã—ãŸfunctionã‚’mutableã«ãªã‚‹ã‚ˆã†ã«hooksã‚’ä½œæˆã—ã¾ã™ã€‚
Reactã¯ `state` ã‚’ã€contextã‹ã‚‰å‚ç…§ã—ãŸã‚Šã€å›ºæœ‰ãªfunctionã«ã§ãã¾ã™ãŒã€
vanillaã§ã¯ `useContext` ã‚„ `useRef` ãŒä½¿ãˆãªã„ã®ã§ã€`id` ã‹ã‚‰ä¿å­˜ã•ã›ã¾ã™ã€‚

---

```js
// for React
const _fun = (_state={}) => false;

function useRaf(fun=_fun, deps=[]) {
  const ref = useRef(fun);
  const state = useThreeContext();
  const callback = useCallback(() => ref.current(state), deps);
  useEffect(() => void (ref.current = fun), [fun]);
  useEffect(() => (void state.add(callback)) || (() => state.delete(callback)), deps);
  return state;
}
```

---

```js
// for vanilla
const _fun = (_state={}) => false;
const _three = new ThreeController();
const _currentMap = new Map();
const _callbackMap = new Map();

function useRaf(id='', fun=_fun) {
    const { state } = _three;
    if (_currentMap.get(id) !== fun)
      _currentMap.set(id, fun);
    const callback =
      _callbackMap.get(id) ||
      _callbackMap.set(id, () => _currentMap.get(id)?.(state)).get(id);
    state.add(callback);
    return state;
}
```

---

### useThree, useFrame, useLoader ã«ã¤ã„ã¦

æœ€å¾Œã«ã€API ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã§ã€r3fã¨åŒã˜ã‚ˆã†ã«ã‹ãã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸€åº¦ã ã‘å®Ÿè¡Œã—ãŸã‚Šã€3D Modelã®LoadãŒå®Œäº†ã—ãŸã‚ã¨ã«ã€functionã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

---

```js
// for React
const useThree = (fun=_fun, deps=[]) => useRaf((state) => fun(state) && false, deps);
const useFrame = (fun=_fun, deps=[]) => useRaf((state) => fun(state) || true, deps);
const useLoader = (fun=_fun, deps=[]) => useRaf((state) => state.isLoaded? fun(state) && false: true, deps);
```

```js
// for vanilla
const useThree = (id='', fun=_fun) => useRaf(id, (state) => fun(state) && false);
const useFrame = (id='', fun=_fun) => useRaf(id, (state) => fun(state) || true);
const useLoader = (id='', fun=_fun) => useRaf(id, (state) => state.isLoaded? fun(state) && false: true);
```

---

### Conclusion

æœ€åˆã¨åŒã˜ã‚ˆã†ã«ã€vanillaã§ã‚‚r3fã®codeã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```js
function useOrbit() {
  const controlsRef = { current: null };

  useFrame('updateOrbit', () => void controlsRef.current?.update());

  useThree('setupOrbit', (state) => {
    controlsRef.current = new OrbitControls(state.camera, state.gl.domElement);
  });
}
```

---

<div align="center">

###### Happy HardCodeğŸ™ƒ

</div>
