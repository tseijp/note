---
tags: [Django, AWS]
title: Django in AWS and Nginx
description: Django in AWS and Nginx
authors: tsei
image: https://github.com/tseijp.png
hide_table_of_contents: false
---

# Django in AWS and Nginx

ä»Šå¹´ã®æ˜¥ã«Djangoã‚’å‹‰å¼·ã—ã¦ã€gunicornã¨Herokuã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã‚’
åŠå¹´æ”¾ç½®ã—ã¦ã„ãŸã‚‰ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã§å‹•ã‹ãªããªã£ã¦ã„ã¾ã—ãŸã€‚ã€‚ã€‚

AWSãŒKyashã¨ã„ã†ãƒ‡ãƒ“ãƒƒãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ãˆãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚
ä¸‹ã®ã‚µã‚¤ãƒˆé€šã‚Šã«ã—ãŸã‚‰ã†ã¾ãã„ãã¾ã—ãŸã€‚ï¼ˆç‰¹ã«æœ€åˆã®ã‚µã‚¤ãƒˆå‡„ã„ï¼20åˆ†ï¼ï¼‰ã€‚
AWSã§åˆã‚ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã®ã§ã€ä½œæ¥­ä¸­ã®ãƒ¡ãƒ¢ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

<!--truncate-->

__REF__: [[1][1]], [[2][2]], [[3][3]], [[4][4]], [[5][5]], [[6][6]]
1.  [ã€20åˆ†ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€‘AWS EC2ã«Django+PostgreSQL+Nginxç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã‚µã‚µãƒƒã¨å…¬é–‹ - Qiita][1]
1. [Djangoã®æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ec2ã«ãƒ‡ãƒ—ãƒ­ã‚¤ - Qiita][2]
1. [ã€AWSã§ã‚µã‚¤ãƒˆåˆ¶ä½œ5ã€‘ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š - Qiita][3]
1. [AWS Route 53ã‚’ä½¿ã£ã¦ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®Webãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã‚ˆã† | Avintonã‚¸ãƒ£ãƒ‘ãƒ³æ ªå¼ä¼šç¤¾][4]
1. [ãŠåå‰.comã§å–ã£ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’AWSã®ã€ŒRoute 53ã€ã§åˆ©ç”¨ã™ã‚‹ | melon.Lab][5]
1. [EC2ä¸Šã®Djangoã‚¢ãƒ—ãƒªã‚’ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã€SSLå¯¾å¿œã™ã‚‹ - Qiita][6]

[1]: https://qiita.com/tachibanayu24/items/b8d73cdfd4cbd42c5b1d
[2]: https://qiita.com/kur/items/fb75354ee53671c79614
[3]: https://qiita.com/HitomiHoshisaki/items/7d7345eb67390f16fed4
[4]: https://avinton.com/academy/route53-dns-vhost/
[5]: https://mel.onl/onamae-domain-aws-route-53/#toc2
[6]: https://qiita.com/moto2g/items/e6454a51d61570948171

## AWS EC2
æœ€åˆé–“é•ãˆã¦Ubuntuã‚’é¸ã‚“ã§ãªãã¦æ°—ã¥ãã®ã«æ™‚é–“ã‹ã‹ã‚Šã¾ã—ãŸã€‚ã€‚ã€‚(;__;)

1. ã‚µãƒ¼ãƒ“ã‚¹(å·¦ä¸Š) â†’ EC2 â†’ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(å·¦å´)â†’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç®¡ç†ç”»é¢ã¸
1. [ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ] ã‚’æŠ¼ä¸‹ â†’ `AMI(Amazon Machine Image)`ã«Ubuntué¸æŠ â†’ æ–°è¦ã«ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ â†’ `aws_ubuntu.pem` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ãŒrunningã‹ã‚’ç¢ºèª
1. `chmod 400 aws-ubuntu.pem`:ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´â†’è‡ªåˆ†ã®`~/.ssh`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‹ã«ä¿ç®¡
1. `ssh -i "~/.ssh/aws_ubuntu.pem" ubuntu@<ip address>`:ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ubuntuä»¥å¤–ã ã¨ec2-userã¨ã‹

## Ubuntu env
Ubuntuã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€ä½œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§sshã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

1. `sudo -i`
1. `apt update -y`
1. `adduser <app-user>` : ubuntuä»¥å¤–ã¯useraddã§ã¾ãŸé•ã†ã‚‰ã—ã„
1. `gpasswd -a user_name sudo` : sudo ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
1. `usermod -aG sudo <app-user>`
1. `cp -r /home/ec2-user/.ssh /home/<app-user>/.ssh`
1. `chown -R <app-user>:<app-user> /home/<app-user>/.ssh`
1. `sudo su <app-user>`
1. `chmod 0600 ~/.ssh/authorized_keys`

## Python env
1. `apt install python3-pip python3-dev libpq-dev postgresql postgresql-contrib`
1. `sudo -H pip3 install virtualenv`
1. `virtualenv <venv_name>`
1. `source <venv_name>/bin/activate`
1. `pip install django gunicorn psycopg2 psycopg2-binary Pillow`

## PostgreSQL

Herokuã¨ã‹ã¨ã ã„ãŸã„åŒã˜ã§ã—ãŸã€‚

1. `sudo -u postgres psql`
1. `CREATE DATABASE <DB_NAME>;`
1. `CREATE USER <DB_USERNAME> WITH PASSWORD '<DB_PASSWORD>';`
1. `ALTER ROLE <DB_USERNAME> SET client_encoding TO 'utf8';`
1. `ALTER ROLE <DB_USERNAME> SET default_transaction_isolation TO 'read committed';`
1. `ALTER ROLE <DB_USERNAME> SET timezone TO 'UTC+9';`
1. `GRANT ALL PRIVILEGES ON DATABASE <DB_NAME> TO <DB_USERNAME>;`

```python
...
ALLOWED_HOSTS = ['{{ip adress}}']
...
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': '{{DB_NAME}}',
        'USER': '{{DB_USERNAME}}',
        'PASSWORD': '{{DB_PASSWORD}}',
        'HOST': 'localhost',
        'PORT': '',
    }
}
```

## AWS
1. å·¦ã‚«ãƒ©ãƒ ã‹ã‚‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ— â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
1. ä½œæˆã—ãŸã‚‚ã®ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ«ãƒ¼ãƒ«ã®ä½œæˆ â†’
    1. `ã‚«ã‚¹ã‚¿ãƒ TCPâ–½`,
    1. `TCP`,
    1. `8000`
    1. `0,0,0,0/0`
1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ â†’ å³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚° â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ â†’ ä½œæˆã—ãŸã‚‚ã®ã‚’é¸æŠ
1. `python3 manage.py runserver 0.0.0.0:8000`
1. `http://<your_ip>:8000`ã§ç¢ºèª â†’ `deactivate`:venvã¬ã‘ã‚‹

## gunicorn
gunicornã®è¨­å®šã‚’ã—ã¾ã™ã€‚è‡ªåˆ†ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ã¾ã™ã€‚
gunicornã®å ´æ‰€ã‚’é–“é•ãˆã¦ã¯ã¾ã£ãŸã®ã§æ°—ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚ï¼ˆvenvä½¿ã£ãŸã‹ã§å¤‰ã‚ã‚Šã¾ã™ï¼‰

1. `sudo vi /etc/systemd/system/gunicorn.service`
1. `sudo systemctl start gunicorn.service`
1. `sudo systemctl enable gunicorn`

```bash
[Unit]
Description=gunicorn daemon
After=network.target
[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/<PJ_NAME>
ExecStart={{`which gunicorn` ã§ã§ãŸpath. **/gunicornã¨ã‹}}
--workers 3 --bind unix:/home/{{user}}/{{prj}}/{{prj}}.sock
{{prj_name}}.wsgi:application
--access-logfile "{{any_dir}}/access.log"
--error-logfile "{{any_dir}}/error.log"
[Install]
WantedBy=multi-user.target
```

## nginx
nginxã®è¨­å®šã‚’ã—ã¾ã™ã€‚ä¸€åº¦ã—ãŸã‚‰ã‚ã‚“ã¾ã‚Šè§¦ã‚Œãªã„ã§ã™ã€‚viã‚’ä½¿ã„ã¾ã™ğŸ”¥

1. `sudo vi /etc/nginx/sites-available/<PJ_NAME>`
1. `sudo ln -s /etc/nginx/sites-available/<PJ_NAME> /etc/nginx/sites-enabled/`
1. `sudo systemctl restart nginx`
1. `sudo ufw delete allow 8000`
1. `sudo ufw allow 'Nginx Full'`

```
server {
    listen 80;
    server_name <EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP>;
    location = /favicon.ico {access_log off; log_not_found off;}
    location /static/ {
        root /home/ubuntu/<PJ_NAME>;
    }
    location / {
        include proxy_params;
        proxy_pass http://unix:/home/ubuntu/<PJ_NAME>/<PJ_NAME>.sock;
    }
}
```

## ec2
1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ— â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¿ã‚¤ãƒ—: HTTPã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
1. ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚° â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´â†’ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠï¼‰â†å…ˆã»ã©ã—ã¦ãªã‹ã£ãŸã‚‰

### Elastic IPs
1. ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ Elastic IPsã‹ã‚‰ãƒãƒãƒãƒ
1. Elastic IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰²ã‚Šå½“ã¦ â†’ å‰²ã‚Šå½“ã¦
1. Elastic IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é–¢é€£ä»˜ã‘ â†’ é–¢é€£ä»˜ã‘

## domain
ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã‚µãƒ¼ãƒãƒ¼ã®ç¹‹ã’æ–¹ãŒã„ã‚ã„ã‚ã‚ã£ã¦æ··ä¹±ã—ã¾ã™ãŒã€
[ãŠåå‰.comã§ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—ã¨Route 53ã¨ã®é€£æº(ãŠåå‰.comã¸ã®Route 53DNSç™»éŒ²) - ã®ã´ã´ã®ãƒ¡ãƒ¢][np]
ãŒå„ãƒ¡ãƒªãƒƒãƒˆãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¦ã€çµå±€ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’ã„ã˜ã‚‹ã®ãŒãŒä¸€ç•ªæ¥½ã§ã—ãŸ

[np]: http://nopipi.hatenablog.com/entry/2019/01/03/132701

1. AWS SERVICE â†’ Route 53 â†’ DNS ç®¡ç† â†’ Create Hosted Zone â†’ å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨˜å…¥ â†’ create
1. ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã®è©³ç´° â†’ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆã®ä½œæˆ â†’ type:A, value:<å–å¾—ã—ãŸElastic IPè¨˜å…¥> â†’ ä½œæˆ
1. ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆã®ä¸€è¦§ã«å…ƒã€…ã‚ã‚‹Type:NSã®å››ã¤ã®valueï¼ˆns-\*\*.\*\*.\*\*ï¼‰ã‚’æ§ãˆã¦ãŠã
1. ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆã®ä¸€è¦§ã®ã„ãšã‚Œã‚’é¸æŠ â†’ TTLï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹æ™‚é–“ï¼‰ã‚’300sã«è¨­å®š
1. ãŠåå‰.com â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§ â†’ å–å¾—ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é¸æŠ â†’ ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼æƒ…å ±
1. ä»–ã®ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’åˆ©ç”¨ â†’ ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã«å…ˆã»ã©ã®NSã®å››ã¤ã®value â†’ è¨­å®š
1. `sudo vi /etc/nginx/sites-available/<PJ_NAME>` â†’ `server_name <your doman> <your Elastic IP>;`
1. `vi <PJ_NAME>/<settings file>.py` â†’ `ALOWED_HOST=["<DOMAIN>","<Elastic IP>"]`


## SSL
HTTPSã§ç¹‹ãŒã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

1. [certbot][certbot]ã§Ubuntuã¨Nginxé¸æŠâ†’ã‚³ãƒãƒ³ãƒ‰ä¸Šã‹ã‚‰å®Ÿè¡Œ
1. `sudo add-apt-repository universe`ãŒã§ããªã„ã®ã§ã€URLã‹ã‚‰ç›´æ¥å…¥ã‚Œã‚‹
1. `sudo certbot --nginx`ã§ãƒãƒãƒãƒ â†’ `whether or not to redirect HTTP`ã§2ã‚’é¸æŠ
1. `sudo certbot renew --post-hook "systemctl restart nginx"`:ã‚’è©¦ã™
1. `sudo vi /etc/cron.d/letsencrypt` â†’ `0 1 * * 1 sudo certbot renew --post-hook "systemctl restart nginx"`
1. ec2 â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ— â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¿ã‚¤ãƒ—: HTTPSã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 

[certbot]: https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx
