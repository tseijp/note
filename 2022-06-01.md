---
marp: true
title: "Stateful React via event"
description: "Stateful React via event"
authors: tsei
hide_table_of_contents: false
image: https://github.com/tseijp.png
tags: [React.js, Redux, jotai, hooks]
---

# Stateful React via Event

[demo]: https://codesandbox.io/s/keycontroller-test-ukfk8l
[coldi]: https://github.com/coldi/r3f-game-demo
[0501]: https://tsei.jp/articles/2022/05/01/note/
[1129]: https://tsei.jp/articles/2021/11/29/note/
[each]: https://github.com/pmndrs/react-spring/blob/a1d86e0cc60c3e2fd6743b28a958c0ec81525d55/packages/shared/src/helpers.ts#L47

state ç®¡ç†ã‚’ã™ã‚‹ã¨ãã€`React`ã§ã¯`Redux`ã‚„`jotai`ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¾ã™ãŒã€
ä»Šå›ã¯ `event listener` ã®ã‚ˆã†ã« state ç®¡ç†ã§ãã‚‹ã‚ˆã†ãªæ§‹é€ ã‚’ã¤ãã£ã¦ã¿ã¾ã—ãŸã€‚
[KeyController test - CodeSandbox][demo] ã‹ã‚‰ã‚ãã¹ã¾ã™ã€‚

<!-- truncate -->

ä»Šå›ã¯ã€ KeyEvent ã«ã‚ˆã£ã¦ã€æ–‡å­—åˆ—ã‚’ã‹ãˆã‚‹ App ã‚’ã¤ãã‚Šã¾ã—ãŸã€‚
`KeyInput` ã§ã¤ãã£ãŸ function ã‚’ã€ä»–ã®è‡ªç”±ãªå ´æ‰€ã‹ã‚‰å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ `Key` Provider ã¨ `useKey` ã® API ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

---

```js
function KeyInput() {
  const [key, setKey] = React.useState("");
  useKey(" ", (___, _ = "_") => setKey((p) => p + _) || 1);
  return <div>{key || "PRESS_KEYBOARD"}</div>;
}

const A = () => void useKey("a", (key) => key(" ", "A") || 1);
const B = () => void useKey("b", (key) => key(" ", "B") || 1);
const C = () => void useKey("c", (key) => key(" ", "C") || 1);
{/* D to Z */}

root.render(
  <Key>
    <KeyInput />
    <A />
    <B />
    <C />
    {/* D to Z */}
  </Key>
)
```

---

## Getting Started

---

### `makeEvent` ã«ã¤ã„ã¦

ä»Šå›ã¯ [`coldi` ã¨ã„ã†æ–¹ã®ãƒªãƒã‚¸ãƒˆãƒª][coldi] ã® `createPubSub.ts` ã‚’å‚è€ƒã«ã—ã¦ã€
[å‰å›ç´¹ä»‹ã—ãŸ `makeQueue` ][0501] ã‚’æ‹¡å¼µã—ãŸ `makeEvent` ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

---

```js
function makeEvent() {
  const map = new Map();
  return {
    add(fun, key) {
      const queue = map.get(key) || map.set(key, makeQueue()).get(key);
      queue.add(fun);
    },
    delete: (fun, key) => map.get(key)?.delete?.(fun),
    flush: (key, ...args) => map.get(key)?.flush?.(...args)
  }
}
```

---

### helpers ã«ã¤ã„ã¦

ã¾ãŸã€[å‰å›][0501] ã‹ã‚‰ã€objectã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€[`each`][each] ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
`Array` , `Set` ã‚„ `Map` ã§ã¯ãªã‚‹ã¹ã `forEach` ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚
TypeScriptã§ã¯ `typeof` ãŒä½¿ã„ã«ãã„ã®ã§ã€ `is` ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

---

```js
function each(obj, fun, ctx) {
  if (is.arr(obj) || is.set(obj) || is.map(obj)) obj.forEach(fun, ctx);
  else for (const key in obj)
    if (obj.hasOwnProperty(key)) fun.call(ctx, obj[key], key);
}

const is = {
  arr: Array.isArray,
  str: (a) => typeof a === "string",
  obj: (a) => a?.constructor?.name === "Object",
  set: (a) => a?.constructor?.name === "Set",
  map: (a) => a?.constructor?.name === "Map"
};
```

---

### `Controller` ã®ä½œæˆ

[å‰å›][0501]ã¨åŒã˜ã‚ˆã†ã«ã€`Controller` ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã“ã® class ã‚’å„æ‹¡å¼µã™ã‚‹ã“ã¨ã§ã€æ§˜ã€…ãª state ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

```js
const _obj = (key, fun) => (is.str(key) ? { [key]: fun } : key);
const _arr = (arg) => (is.arr(arg) ? arg : [arg]);


class Controller {
  constructor() {
    const event = makeEvent();
    const flush = (...args) => (p, k) => event.flush(k, ...args, ..._arr(p));
    const state = (key, ...args) => each(_obj(key, []), flush(state, ...args));
    state.add = (events) => each(events, event.add);
    state.delete = (events) => each(events, event.delete);
    state.memo = {};
    this.state = state;
  }
  {/*~~ âŠ ~~*/}
}
```

---

ã¤ãã®ã‚ˆã†ãª class method ã‚’ `Controller` ã® âŠ ã«è¿½åŠ ã—ã€
hookã‹ã‚‰ä½¿ã†ã¨ã€class based ã§ React ã‚’ã¤ã‹ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[class based React.js hooks | TSEI.JP][1129] ã‚’ã”è¦§ãã ã•ã„ã€‚

---

```js
  effect() {
    const { state } = this;
    if (state.isInitialized) return false;
    return (state.isInitialized = true);
  }
  clean() {
    const { state } = this;
    if (state.isInitialized) return false;
    return !(state.isInitialized = false);
  }
  apply(props) {
    this.props = props;
    return this.state;
  }
```

```js
function useCtrl(Controller, props) {
  const [ctrl] = useState(() => new Controller());
  useEffect(() => void ctrl.effect());
  useEffect(() => () => ctrl.clean(), [ctrl]);
  return ctrl.apply(props);
}
```

---

### useEvent ã«ã¤ã„ã¦

ä½œæˆã—ãŸ `Controller.state` ã¸ã€è‡ªç”±ã« function ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã²ã¨ã¤ã ã‘ function ã‚’ è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã€ string ã‹ã‚‰ object ã«ã™ã‚‹ `_obj` ã‚’ä½¿ã„ã¾ã—ãŸã€‚

```js
function useEvent(state, ...args) {
  const ref = useMutable(_obj(...args));
  useEffect(() => void state.add(ref), [state, ref]);
  useEffect(() => () => state.delete(ref), [state, ref]);
  return state;
}
```

---

### `useMutable` ã«ã¤ã„ã¦

[å‰å›][0501] ã¨åŒã˜ãã€function ãŒé‡è¤‡ã—ã¦è¿½åŠ ã•ã‚Œãªã„ã‚ˆã†ã«ã€å›ºæœ‰ãª function ã«ã—ã¾ã™ã€‚

```js
function useMutable(target) {
  const ref = useRef();
  ref.current = target;
  return useMemo(() => {
    const memo = {};
    each(ref.current, (fun, key) => {
      memo[key] = (...args) => fun(...args);
    });
    return memo;
  }, []);
}
```

---

## create your app

ä»Šå›ã¯ã€Keyboard ã‚’ä½¿ã†ãŸã‚ã®APIã‚’ã¤ãã‚Šã¾ã™ã€‚

```js
class KeyController extends Controller {
  keydown = (e) => this.state(e.key);
  effect() {
    if (super.effect()) window.addEventListener("keydown", this.keydown);
  }
  clean() {
    if (super.clean()) window.removeEventListener("keydown", this.keydown);
  }
}
```

---

å¿…è¦ãª API ã‚’ã¤ãã‚‹ã¨ã€ã¯ã˜ã‚ã® App ã«ãªã‚Šã¾ã™ã€‚

```js
import * as React from "react";
import { createRoot } from "react-dom/client";
import { Controller, useCtrl, useEvent } from "./hooks";

const KeyContext = React.createContext({});
const KeyProvider = KeyContext.Provider;
const useKeyContext = () => React.useContext(KeyContext);
const useKey = (...args) => useEvent(useKeyContext(), ...args);

function Key(props) {
  const { children, ...other } = props;
  const state = useCtrl(KeyController, other);
  return <KeyProvider value={state} children={children} />;
}

{/* ~~~ */}
```

---

<div align="center">

###### Happy HardCodeğŸ™ƒ

</div>
