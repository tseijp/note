---
tags: [webpack, rollup, JavaScript]
title: build with webpack and rollup
description: build with webpack and rollup
authors: tsei
image: https://github.com/tseijp.png
hide_table_of_contents: false
---


# build with webpack and rollup
__REF__
- [create-react-appã§ãƒ•ã‚©ãƒ«ãƒ€å(src)ã‚’å¤‰æ›´ã™ã‚‹å…·ä½“çš„ãªæ‰‹é †](https://freelance-jak.com/technology/react/2409/)
- [create-react-app ã§ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’rollupã§æ•´å½¢ã™ã‚‹](https://qiita.com/kspotfujita/items/f3a50f613828170170ba)
- [Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’npmã§å…¬é–‹ã™ã‚‹](https://qiita.com/Takumon/items/945335b0e0fa035f2201)

ã‚¢ãƒ—ãƒªã«ã¯cssç­‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ‰±ãˆã‚‹`webpack`, ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç¸®å°ã—ã¦å¤‰æ›ã—ã¦ãã‚Œã‚‹`rollup`ãŒä½¿ã„ã‚„ã™ã„ã§ã™ã€‚
ç‰¹ã«`create-react-app`ã§Reactç’°å¢ƒã‚’ä½œæˆå¾Œã€ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã®ä½œæˆã¨åŒæ™‚ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é–‹ç™ºã™ã‚‹ã®ãŒå®‰å®šã—ã¦ã„ã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚
ä»Šå›ã¯ã€`cross-env`ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¨­å®šã—ã€`react-app-rewired`ã§`create-react-app`ã®ä¸­ã®è¨­å®šã‚’å¤‰æ›´ã—ã¾ã™.
tsã‚„cssãªã©è¿½åŠ ã§ç”¨ã„ã‚‹å ´åˆã¯[rollup/plugins: ğŸ£](https://github.com/rollup/plugins)ã‹ã‚‰ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é¸ã‚“ã§ä½¿ã„ã¾ã™ã€‚
- `create-react-app {yourapp}` and `cd {yourapp}`
- `npm i -D cross-env react-app-rewired rollup @rollup/plugin-babel @rollup/plugin-node-resolve @rollup/plugin-commonjs fs`

æ¬¡ã«`config-overrides.js`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚(ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’`src`ã‹ã‚‰`docs`ã«å¤‰æ›´ã™ã‚‹ã€‚`appSrc`ã‚’`src`ã‹ã‚‰`.`ã«ã™ã‚‹ã¨ã€`src`ã¨`docs`ã®ä¸¡æ–¹ãŒã¤ã‹ãˆã‚‹ã€‚)
```jsx
const fs = require('fs');
const path = require('path');
const appDirectory = fs.realpathSync(process.cwd());
const resolveApp = relativePath => path.resolve(appDirectory, relativePath);
module.exports = {
  paths: function(paths, env) {
    paths.appSrc   = resolveApp('.');
    paths.appIndexJs = resolveApp('docs/index.js');
    // Typescript ã®å ´åˆ
    // paths.appTypeDeclarations = resolveApp('docs/react-app-env.d.ts');
    return paths;
  }
}
```

æ¬¡ã«`package.json`ã‚’ä¿®æ­£ã—ã¾ã™ã€‚ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«ã¯`rollup`ã‚’ç”¨ã„ã€ä»–ã¯`react-app-rewired`ã‚’ä½¿ã†ã€‚ï¼‰Typescriptã®å ´åˆã¯ã€`tsconfig.json`ã®`include:[...]`ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¿®æ­£ã—ã¾ã™.
```json
{
  "module": "index.js",
  "types": "index.d.ts",
  "main": "index.cjs.js",
  "private": false,
  "scripts": {
  "test":"react-app-rewired test",
  "eject":"react-app-rewired eject",
  "start":"cross-env NODE_ENV=development BABEL_ENV=development react-app-rewired start",
  "build":"cross-env NODE_ENV=production BABEL_ENV=production react-app-rewired build",
  "compile":"cross-env NODE_ENV=production BABEL_ENV=production rollup -c config-rollup.js"
  },
  ~~çœç•¥~~
}
```

å…ˆç¨‹ã€`scripts`ã®`compile`ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®`config-rollup.js`ã‚’è¿½åŠ ã—ã¾ã™.
ï¼ˆ`json`ã‚„`glsl`ã‚’ã¤ã‹ã†ãªã©ã€å ´åˆã«ã‚ˆã£ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€`plugins`ã«è¿½åŠ ã—ã¦ã„ãï¼‰
```jsx
import { promises as fs } from 'fs';
import babel from '@rollup/plugin-babel';
import resolve from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';
import pkg from './package.json';

const input = 'src/index'
const external = Object.keys({...pkg.dependencies,...pkg.devDependencies})
const extensions = ['.js', '.jsx', '.ts', '.tsx']

function babelOption (useESModules) {
  return {
    babelrc:false,
    babelHelpers:'runtime',
    exclude:'**/node_modules/**',
    extensions,
    presets : [
      ['@babel/env', {loose:true, modules:false}],
       '@babel/preset-react','@babel/preset-typescript'
    ],
    plugins : [
      [ '@babel/proposal-class-properties'     ,  {loose:true} ],
      [ '@babel/plugin-proposal-object-rest-spread',  {loose:true} ],
      [ '@babel/transform-runtime', {regenerator:false,useESModules} ],
    ],
  }
}
```

```jsx
function targetTypings(out) {
  return {
  writeBundle () {
    return fs.lstat(pkg.types).catch(() => {
    return fs.writeFile(pkg.types, `export * from "./${input}"`)
    })
  }
  }
}

export default [
  { input, output:{file:pkg.main   ,format:'cjs'}, external, plugins:[
    babel( babelOption(true) ),
    commonjs({extensions}),
    resolve ({extensions}),
    targetTypings(),
  ]},
  { input, output:{file:pkg.module ,format:'esm'}, external, plugins:[
    babel( babelOption(false) ),
    commonjs({extensions}),
    resolve ({extensions}),
    targetTypings(),
  ] },
]
```

### npm publish

- ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ãŒã§ããŸã‚‰ã€`npm run build`
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã§ããŸã‚‰ã€`npm run compile`
- `.npmignore`ã‚’ä½œæˆã—, rollupã§ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨README.mdä»¥å¤–ã‚’æŒ‡å®šã™ã‚‹.
- `npm publish`ã§å…¬é–‹
```bash
.git
.gitignore
build
docs
node_modules
public
scripts
```
